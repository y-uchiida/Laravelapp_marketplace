# Laravelにおける非同期処理

## キューの設定
キュー（待ち行列）をどこに保存しておくかを設定する  
`config/queue.php` に記述がある  
初期値は`sync` で、同期的実行されるようになっている  
DBのテーブルに保存したり、Redisに保存したり、などいくつかのドライバーがあるので、  
これらの設定をしてキューの保存場所に利用すると、非同期的に実行できるようになる

## 利用するキューのドライバーの切り替え
`.env` の`QUEUE_CONNECTION` でドライバーを設定する  
初期値は `sync`になっているので、これを別のドライバー名に変更する

## キューにdatabase ドライバーを利用する手順
1. .env ファイルのQUEUE_CONNECTION をdatabaseに変更する
2. .env のキャッシュを削除する  
   `php artisan config:cache`  
3. ジョブを保存するためのテーブルを作成する  
   以下のartisan コマンドを実行するとマイグレーションファイルが生成される
   `php artisan queue:table`  
   生成されたマイグレーションファイルを適用すると、ジョブを保持するための`jobs` テーブルが追加される  
   テーブルの設定内容はartisan が作った内容そのままでOK
4. ジョブクラスの作成  
   非同期に実行される一連の処理をまとめたものを、Jobクラスとして作成する  
   artisan コマンドから、ひな形を作成する
   ```bash
   # app\Jobs\TestJob.php が生成される
   $ php artisan make:job TestJob
   ```
5. ジョブクラスの handle() メソッドに、実行する処理を記述する  
   `handle()` メソッドの内容が、ジョブクラスをキューに渡したときに実行される  
6. dispath() メソッドで待ち行列に追加する  
   コントローラなどから、Job クラスのクラスメソッド`dispatch()` を実行する  
   ```php
   /* アクションメソッドなど */
   /* TestJob() を一つ、待ち行列に追加する（jobs テーブルのレコードに追加） */
   TestJob::dispatch();
   ```
7. ワーカープロセスを起動する  
   Laravelはそのままではワーカープロセスを起動しない  
   artisan コマンドでワーカープロセスを起動する必要がある
   ```bash
   # ワーカープロセスを起動する
   $ php artisan queue:work
   ```

## 失敗したジョブのログ
デフォルトで保持されるのは2箇所
1. ログファイルに記述される  
   `storage/logs/laravel.log`
2. データベースの`failed_jobs` テーブルに記録される  
   `failed_jobs` テーブルはデフォルトで作成されるテーブル  
   どのキュードライバを使っていても記録される模様
